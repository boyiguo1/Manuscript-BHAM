---
title: "Sim_tuning Report"
author: "Boyi Guo"
date: "5/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(here)
library(reshape)
library(glue)
library(unglue)
library(knitr)
library(flextable)
```

# Computation environment

* Run on UAB Cheaha cluster. Find more description at [https://docs.uabgrid.uab.edu/wiki/Cheaha](https://docs.uabgrid.uab.edu/wiki/Cheaha)
* For the sake of time, the maximum number of iterations are set to 10 for all bglm methods.

# Restuls

* Poisson outcomes requires extremely more time to finish

* `bmlasso` doesn't not work well in gaussian outcomes. Similarly as we previously observed in netwrok ss studies

* Tuning parameter `s0` matters when the number of outcome grows exponentially.

## Simulation Finish Rate
```{r sim_finish_rate}
sims <- list.files(here("Simulation/tuning/Data"),full.names =TRUE)

success_rate <- map_dfr(sims, .f = function(sim){
  # sim <- sims[4]
  sim.df <- unglue_data(sim,
                        "{}/bgam_{study}_-dist_{dist}-p_{p}") %>%
    mutate( p = as.numeric(p))
  fls <- list.files(sim, full.names = TRUE)
  fls <- fls[grep(".rds", x=fls)]
  n <- length(fls)

  data.frame(sim.df, n_success = n, path = sim)
}) %>%
  arrange(dist, p)

success_rate %>% 
  select(-path) %>% 
  flextable()
```

## Binomial Distribution
```{r}
success_rate %>% 
  filter(dist=="binomial", n_success!=0) %>% 
  pull(path) %>% 
  map_dfr( .f = function(sim){
  # sim <- sims[3]
  sim.df <- unglue_data(sim, 
                        "{}/bgam_{study}_-dist_{dist}-p_{p}") %>% 
    mutate( p = as.numeric(p))
  fls <- list.files(sim, full.names = TRUE) 
  fls <- fls[grep(".rds", x=fls)]
  n <- length(fls)
  
  
  if(n == 0)
    return(data.frame(NULL))
  
  # .file <- fls[1]
  
  ret <- fls %>%
    map_dfr(.f = function(.file){
    it <- unglue_data(.file, "{whatever}/it_{it}.rds") %>% pull(it) %>% as.numeric
    ret <- data.frame(
      it = it,
      read_rds(.file) #%>%
        # data.frame %>%
        # rownames_to_column("method") %>%
        # select(method, measure) %>%
        # pivot_wider(names_from = method,
        #             values_from = measure,
        #             names_glue = "{method}_{.value}"
        #             )
    )
    }) %>%
    arrange(it) %>% 
    arrange(mdl, s0) %>% 
    mutate(s0 = factor(s0),
           p = sim.df$p)  
}) %>% 
ggplot(
       aes(x = s0, y = auc)) +
  geom_jitter() +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))+
  # coord_flip() +
  facet_grid(cols = vars(mdl),
             rows= vars(p))
```


### Gaussian Outcome
```{r}
success_rate %>% 
  filter(dist=="gaussian", n_success!=0) %>% 
  pull(path) %>% 
  map_dfr( .f = function(sim){
    # sim <- sims[3]
    sim.df <- unglue_data(sim, 
                          "{}/bgam_{study}_-dist_{dist}-p_{p}") %>% 
      mutate( p = as.numeric(p))
    fls <- list.files(sim, full.names = TRUE) 
    fls <- fls[grep(".rds", x=fls)]
    n <- length(fls)
    
    if(n == 0)
      return(data.frame(NULL))
    
    # .file <- fls[1]
    
    ret <- fls %>%
      map_dfr(.f = function(.file){
        it <- unglue_data(.file, "{whatever}/it_{it}.rds") %>% pull(it) %>% as.numeric
        ret <- data.frame(
          it = it,
          read_rds(.file) #%>%
          # data.frame %>%
          # rownames_to_column("method") %>%
          # select(method, measure) %>%
          # pivot_wider(names_from = method,
          #             values_from = measure,
          #             names_glue = "{method}_{.value}"
          #             )
        )
      }) %>%
      arrange(it) %>% 
      arrange(mdl, s0) %>% 
      mutate(s0 = factor(s0),
             p = sim.df$p)  
  }) %>%
ggplot(#data = binom_total_dat,
       aes(x = s0, y = mse)) +
  geom_jitter() +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))+
  # coord_flip() +
  facet_grid(cols = vars(mdl),
             rows= vars(p))
```


### Poisson Outcome
```{r}
success_rate %>% 
  filter(dist=="poisson", n_success!=0) %>% 
  pull(path) %>% 
  map_dfr( .f = function(sim){
    # sim <- sims[3]
    sim.df <- unglue_data(sim, 
                          "{}/bgam_{study}_-dist_{dist}-p_{p}") %>% 
      mutate( p = as.numeric(p))
    fls <- list.files(sim, full.names = TRUE) 
    fls <- fls[grep(".rds", x=fls)]
    n <- length(fls)
    
    
    if(n == 0)
      return(data.frame(NULL))
    
    # .file <- fls[1]
    
    ret <- fls %>%
      map_dfr(.f = function(.file){
        it <- unglue_data(.file, "{whatever}/it_{it}.rds") %>% pull(it) %>% as.numeric
        ret <- data.frame(
          it = it,
          read_rds(.file) #%>%
          # data.frame %>%
          # rownames_to_column("method") %>%
          # select(method, measure) %>%
          # pivot_wider(names_from = method,
          #             values_from = measure,
          #             names_glue = "{method}_{.value}"
          #             )
        )
      }) %>%
      arrange(it) %>% 
      arrange(mdl, s0) %>% 
      mutate(s0 = factor(s0),
             p = sim.df$p)  
  }) %>% 
  ggplot(#data = binom_total_dat,
    aes(x = s0, y = deviance)) +
  geom_jitter() +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))+
  # coord_cartesian(ylim=c(-0.5, 1.25))+
  # coord_flip() +
  facet_grid(cols = vars(mdl),
             rows= vars(p))

```

