---
title: "Emory Cardiovscular Biobank"
author: "Boyi Guo"
date: "5/31/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(targets)
library(readr)
library(here)
library(gtsummary)
library(tidyverse)

train_dat <- targets::tar_read(RD_ECB_train_dat)
valid_dat <- targets::tar_read(RD_ECB_valid_dat)
```

#Background

Data was retrieved from <https://datadryad.org/stash/dataset/doi:10.5061/dryad.866t1g1mt> on May 31, 2021.

For study design, please visit the article <https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0237579>

## Data Introducetion

* Two data sets: model development set (N=`r NROW(train_dat)`), validation set (N=`r NROW(valid_dat)`)


* Variable Descriptions
GENEID: subject IDs
timetodeath3yr: time to death event or censoring at three years
death3yr: death event at three years
age: age in years
male: male gender, 1=male, 0=female
BlackRace: black race, 1=black, 0=non-black
batch: batch of metabolomics profiling
Strokehx: history of stroke, 1=yes, 0=no
CABGhx: prior CABG, 1=yes, 0=no
PVDhx: peripheral artery disease, 1=yes, 0=no
eGFR_max120_lt60: estimated glomerular filtration rate less than 60 ml/min/1.73m2, 1=yes, 0=no
curr_smoking: current smoking, 1=yes, 0=no
HFhx: heart failure history, 1=yes, 0=no
HTN: hypertension, 1=yes, 0=no
DM: diabetes, 1=yes, 0=no
mzXX_tXX: intensities of metabolic features

### Covariate Summary
```{r}
list(first_set = train_dat,
     second_set = valid_dat) %>% 
  map(~select(.x, # Data
              age, male, BlackRace,
           Strokehx:DM, 
           death3yr, timetodeath3yr) %>% 
        gtsummary::tbl_summary()
      ) %>% 
tbl_merge()
```


## Primary Data Analysis of Metabolites
```{r eval=F}
train_dat %>% select(starts_with("mz")) %>% 
  summarise_all(var)
```


# Predictive Model

Outcome: `death3yr` (bin)
Covariates: None
Predictors: `starts_with("mz")`

```{r data_split}
library(tidymodels)

set.seed(1)

data_split <- rsample::initial_split(train_dat, prop = 3/4)

train_data <- training(data_split)
test_data <- testing(data_split)
```

## Baseline: Linear Lasso Model

```{r}
library(glmnet)

lasso_mdl_cv <- cv.glmnet(x = train_data %>% select(starts_with("mz")) %>% data.matrix,
                    y = train_data %>% pull(death3yr), alpha = 1,
                    family = "binomial", type.measure = "auc")

lasso_mdl <- glmNet(x = train_data %>% select(starts_with("mz")) %>% data.matrix,
                    y = train_data %>% pull(death3yr), alpha = 1,
                    family = "binomial",lambda = lasso_mdl_cv$lambda.1se)

# class(lasso_mdl) <- c("glmNet", class(lasso_mdl))
measure.bh(lasso_mdl)
# assess.glmnet(lasso_mdl$)

measure.bh(lasso_mdl, new.x = test_data %>% select(starts_with("mz")) %>% data.matrix,
           new.y = test_data %>% pull(death3yr))
```

```{r}
library(BHAM)
library(BhGLM)



mz_names <- train_dat %>% select(starts_with("mz")) %>% names  
sm_df <- data.frame(
  Var = mz_names,
 Func = "s",
 Args ="bs='cr', k=5"
)

sm_obj <- construct_smooth_data(sm_df, train_data)

dsn_mat <- sm_obj$data

# The validation data doesn't overlap with training data
# test_sm_dat <- make_predict_dat(sm_obj$Smooth, dat = valid_dat)

mdl_defaul <- bmlasso(dsn_mat, train_data$death3yr, family = "binomial")

mdl_dflt <- bmlasso_spline(dsn_mat, train_data$death3yr, family = "binomial",
                           group = make_group(names(dsn_mat)))

# Training Data Performance
measure.bh(mdl_defaul)
measure.bh(mdl_dflt)


test_sm_dat <- BHAM::make_predict_dat(sm_obj$Smooth, dat=test_data)

# Testing Data Performance
measure.bh(mdl_defaul, new.x = test_sm_dat, new.y=test_data$death3yr)
measure.bh(mdl_dflt, new.x = test_sm_dat, new.y=test_data$death3yr)
```


# Extremely Penalized Model
```{r}

mdl_pen_extreme <- bmlasso_spline(dsn_mat, train_data$death3yr, family = "binomial",
                           group = make_group(names(dsn_mat)),
                           ss = c(0.001, 0.5))

# Training Data Performance
measure.bh(mdl_pen_extreme)


# Testing Data Performance
measure.bh(mdl_pen_extreme, new.x = test_sm_dat, new.y=test_data$death3yr)
```




## Validation

The validation data set have mostly distinct feature from the training data set. Hence, the validation in the traditional sense does not exists.

```{r eval = F}

test_mz_names <- valid_dat  %>% select(starts_with("mz")) %>% names
measure.bh(mdl_defaul, new.x = test_sm_dat, new.y=valid_dat$death3yr)

measure.bh(mdl_dflt)
```



